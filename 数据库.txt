CREATE TABLE users (
user_id BIGINT PRIMARY KEY AUTO_INCREMENT,
username VARCHAR(100) NOT NULL,
password_hash CHAR(60) NOT NULL,
email VARCHAR(255),
phone VARCHAR(32),
gender ENUM('male','female','other'),
birth_date DATE,
height_cm DECIMAL(5,2),
weight_kg DECIMAL(5,2),
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
UNIQUE KEY uk_users_username (username),
UNIQUE KEY uk_users_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE health_profiles (
profile_id BIGINT PRIMARY KEY AUTO_INCREMENT,
user_id BIGINT NOT NULL,
blood_type ENUM('A','B','AB','O','unknown') DEFAULT 'unknown',
chronic_conditions JSON,
allergies JSON,
medications JSON,
lifestyle_tags JSON,
last_profile_update TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
CONSTRAINT fk_hp_user FOREIGN KEY (user_id) REFERENCES users(user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE health_metrics (
metric_id BIGINT PRIMARY KEY AUTO_INCREMENT,
user_id BIGINT NOT NULL,
recorded_at TIMESTAMP NOT NULL,
source VARCHAR(64),
heart_rate SMALLINT,
blood_pressure_systolic SMALLINT,
blood_pressure_diastolic SMALLINT,
blood_oxygen DECIMAL(4,1),
resp_rate SMALLINT,
temperature DECIMAL(4,1),
glucose DECIMAL(6,2),
sleep_duration DECIMAL(4,1),
stress_level TINYINT,
steps INT,
weight_kg DECIMAL(5,2),
bmi DECIMAL(4,1),
notes TEXT,
CONSTRAINT fk_hm_user FOREIGN KEY (user_id) REFERENCES users(user_id),
INDEX idx_hm_user_time (user_id, recorded_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE alert_rules (
rule_id BIGINT PRIMARY KEY AUTO_INCREMENT,
user_id BIGINT NOT NULL,
metric_field VARCHAR(64) NOT NULL,
threshold_type ENUM('above','below','range') NOT NULL,
threshold_value JSON NOT NULL,
duration_minutes INT DEFAULT 0,
severity ENUM('info','warning','critical') DEFAULT 'info',
notification_channel ENUM('app','sms','email') DEFAULT 'app',
active TINYINT(1) DEFAULT 1,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
CONSTRAINT fk_ar_user FOREIGN KEY (user_id) REFERENCES users(user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE alerts (
alert_id BIGINT PRIMARY KEY AUTO_INCREMENT,
rule_id BIGINT NOT NULL,
user_id BIGINT NOT NULL,
triggered_at TIMESTAMP NOT NULL,
status ENUM('open','ack','resolved') DEFAULT 'open',
message TEXT,
resolved_at TIMESTAMP NULL,
CONSTRAINT fk_alert_rule FOREIGN KEY (rule_id) REFERENCES alert_rules(rule_id),
CONSTRAINT fk_alert_user FOREIGN KEY (user_id) REFERENCES users(user_id),
INDEX idx_alert_user_time (user_id, triggered_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE risk_assessments (
assessment_id BIGINT PRIMARY KEY AUTO_INCREMENT,
user_id BIGINT NOT NULL,
disease VARCHAR(128) NOT NULL,
assessment_date DATE NOT NULL,
risk_score DECIMAL(5,2) NOT NULL,
risk_level ENUM('low','medium','high') NOT NULL,
key_factors JSON,
recommendations TEXT,
model_version VARCHAR(32),
CONSTRAINT fk_ra_user FOREIGN KEY (user_id) REFERENCES users(user_id),
INDEX idx_ra_user_date (user_id, assessment_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE risk_trends (
trend_id BIGINT PRIMARY KEY AUTO_INCREMENT,
user_id BIGINT NOT NULL,
month_start DATE NOT NULL,
predicted_score DECIMAL(5,2),
confidence_low DECIMAL(5,2),
confidence_high DECIMAL(5,2),
model_version VARCHAR(32),
CONSTRAINT fk_rt_user FOREIGN KEY (user_id) REFERENCES users(user_id),
UNIQUE KEY uk_rt_user_month (user_id, month_start)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE chronobiology_plans (
plan_id BIGINT PRIMARY KEY AUTO_INCREMENT,
user_id BIGINT NOT NULL,
baseline_chronotype ENUM('lark','owl','intermediate','unknown') DEFAULT 'unknown',
target_sleep_window JSON,
algorithm_notes TEXT,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
CONSTRAINT fk_cp_user FOREIGN KEY (user_id) REFERENCES users(user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE chronobiology_actions (
action_id BIGINT PRIMARY KEY AUTO_INCREMENT,
plan_id BIGINT NOT NULL,
action_date DATE NOT NULL,
sleep_onset TIME,
wake_time TIME,
light_exposure JSON,
caffeine_intake JSON,
adherence_score DECIMAL(4,1),
feedback TEXT,
CONSTRAINT fk_ca_plan FOREIGN KEY (plan_id) REFERENCES chronobiology_plans(plan_id),
INDEX idx_ca_plan_date (plan_id, action_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE sleep_sessions (
session_id BIGINT PRIMARY KEY AUTO_INCREMENT,
user_id BIGINT NOT NULL,
start_time DATETIME NOT NULL,
end_time DATETIME NOT NULL,
sleep_stage_breakdown JSON,
wake_episodes TINYINT,
sleep_efficiency DECIMAL(5,2),
sleep_quality_score DECIMAL(5,2),
device_source VARCHAR(64),
CONSTRAINT fk_ss_user FOREIGN KEY (user_id) REFERENCES users(user_id),
INDEX idx_ss_user_start (user_id, start_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE workout_prescriptions (
plan_id BIGINT PRIMARY KEY AUTO_INCREMENT,
user_id BIGINT NOT NULL,
goal VARCHAR(255),
training_phase VARCHAR(64),
generated_by VARCHAR(64),
start_date DATE,
end_date DATE,
plan_parameters JSON,
review_notes TEXT,
CONSTRAINT fk_wp_user FOREIGN KEY (user_id) REFERENCES users(user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE workout_sessions (
session_id BIGINT PRIMARY KEY AUTO_INCREMENT,
plan_id BIGINT NOT NULL,
scheduled_date DATE NOT NULL,
actual_date DATE,
activity_type VARCHAR(64),
duration_min SMALLINT,
intensity_level ENUM('low','medium','high'),
calories_burned INT,
metrics_json JSON,
completion_status ENUM('pending','completed','skipped') DEFAULT 'pending',
adherence_score DECIMAL(4,1),
feedback TEXT,
CONSTRAINT fk_ws_plan FOREIGN KEY (plan_id) REFERENCES workout_prescriptions(plan_id),
INDEX idx_ws_plan_sched (plan_id, scheduled_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE nutrition_plans (
plan_id BIGINT PRIMARY KEY AUTO_INCREMENT,
user_id BIGINT NOT NULL,
energy_target_kcal INT,
macro_split JSON,
dietary_restrictions JSON,
recommendations TEXT,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
CONSTRAINT fk_np_user FOREIGN KEY (user_id) REFERENCES users(user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE meals (
meal_id BIGINT PRIMARY KEY AUTO_INCREMENT,
plan_id BIGINT NOT NULL,
meal_time DATETIME NOT NULL,
foods JSON,
calories INT,
macros_json JSON,
glycemic_load DECIMAL(5,2),
satiety_score DECIMAL(4,1),
user_feedback TEXT,
CONSTRAINT fk_meal_plan FOREIGN KEY (plan_id) REFERENCES nutrition_plans(plan_id),
INDEX idx_meal_plan_time (plan_id, meal_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE ai_articles (
article_id BIGINT PRIMARY KEY AUTO_INCREMENT,
title VARCHAR(255) NOT NULL,
summary TEXT,
tags JSON,
source VARCHAR(128),
published_at DATETIME,
relevance_vector JSON,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE user_article_views (
view_id BIGINT PRIMARY KEY AUTO_INCREMENT,
user_id BIGINT NOT NULL,
article_id BIGINT NOT NULL,
viewed_at TIMESTAMP NOT NULL,
engagement_score DECIMAL(5,2),
CONSTRAINT fk_uav_user FOREIGN KEY (user_id) REFERENCES users(user_id),
CONSTRAINT fk_uav_article FOREIGN KEY (article_id) REFERENCES ai_articles(article_id),
INDEX idx_uav_user_time (user_id, viewed_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE visualization_snapshots (
snapshot_id BIGINT PRIMARY KEY AUTO_INCREMENT,
user_id BIGINT NOT NULL,
snapshot_date DATE NOT NULL,
dashboard_config JSON,
kpi_values JSON,
comparison_baseline JSON,
generated_by VARCHAR(64),
CONSTRAINT fk_vs_user FOREIGN KEY (user_id) REFERENCES users(user_id),
UNIQUE KEY uk_vs_user_date (user_id, snapshot_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE audit_logs (
log_id BIGINT PRIMARY KEY AUTO_INCREMENT,
user_id BIGINT,
action VARCHAR(128) NOT NULL,
target_id BIGINT,
target_type VARCHAR(64),
metadata JSON,
logged_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
ip_address VARCHAR(45),
INDEX idx_al_user_time (user_id, logged_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
ALTER TABLE users MODIFY password_hash VARCHAR(255) NOT NULL;
-- 1. 情绪记录表（用户情绪记录）
CREATE TABLE IF NOT EXISTS emotion_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    description TEXT NOT NULL,
    emotion_type VARCHAR(50) COMMENT 'positive/neutral/negative',
    score INT COMMENT '1-10分',
    date DATE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_date (date),
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 2. 心理测评记录表（PHQ-9/GAD-7等量表测评）
CREATE TABLE IF NOT EXISTS assessment_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    questionnaire_type VARCHAR(100) NOT NULL COMMENT 'PHQ-9/GAD-7',
    answers TEXT COMMENT 'JSON数组存储每题得分',
    total_score INT,
    evaluation_result TEXT COMMENT '评估结果（如轻度抑郁）',
    risk_level VARCHAR(50) COMMENT 'low/medium/high/critical',
    record_date DATE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_record_date (record_date),
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 3. 成长计划表（21天压力管理/正念练习等）
CREATE TABLE IF NOT EXISTS growth_plans (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    plan_type VARCHAR(100) NOT NULL COMMENT '21_day_stress/21_day_mindfulness/90_day_health',
    plan_name VARCHAR(255) NOT NULL,
    duration INT COMMENT '计划时长（天）',
    start_date DATE,
    status VARCHAR(50) DEFAULT 'active' COMMENT 'active/completed/abandoned',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 4. 成长计划任务表（关联计划的每日任务）
CREATE TABLE IF NOT EXISTS growth_tasks (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    plan_id BIGINT NOT NULL,
    day INT NOT NULL COMMENT '第N天任务',
    content TEXT NOT NULL,
    task_type VARCHAR(100) COMMENT '意识培养/放松训练/正念练习',
    completed BOOLEAN DEFAULT FALSE,
    completed_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_plan_id (plan_id),
    FOREIGN KEY (plan_id) REFERENCES growth_plans(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;